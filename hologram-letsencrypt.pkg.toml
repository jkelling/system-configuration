[package]
name        = "hologram-letsencrypt"
version     = "1.3.1"
description = "Pluggable letsencrypt-based certificate auto-issuance"

requires       = [
    "certbot",
    "webserver-for-acme-challenge", # virtual package
]

################################################################################
# run letsencrypt under restricted user

[[group]]
name   = "letsencrypt"
system = true

[[user]]
name   = "letsencrypt"
group  = "letsencrypt"
system = true
home   = "/var/lib/letsencrypt"

# webserver needs to be able to read the keys/certs generated by letsencrypt
[[user]]
name   = "http"
groups = ["letsencrypt"]

# fix UID/GID on directories provided by letsencrypt package
[[directory]]
path  = "/etc/letsencrypt"
owner = "letsencrypt"
group = "letsencrypt"
[[directory]]
path  = "/var/lib/letsencrypt"
owner = "letsencrypt"
group = "letsencrypt"
[[directory]]
path  = "/var/log/letsencrypt"
mode  = "0700"
owner = "letsencrypt"
group = "letsencrypt"

# filesystem location for the webroot challenge method
[[directory]]
path = "/srv/letsencrypt/.well-known"
mode  = "0750"
owner = "letsencrypt"
group = "letsencrypt"
[[directory]]
path = "/srv/letsencrypt/.well-known/acme-challenge"
mode  = "0750"
owner = "letsencrypt"
group = "letsencrypt"

# script to interactively (and after that, automatically) issue certificates
#
# To select domains for auto-issuance, place a script below
# /etc/letsencrypt-allofthem that prints the domains that need a certificate.
[[file]]
path    = "/usr/bin/letsencrypt-allofthem"
mode    = "0755"
content = '''
    #!/bin/sh
    if [ "$USER" != "root" ]; then
        echo "!! Run this as user root." >&2
        exit 1
    fi

    set -e

    find /etc/letsencrypt-allofthem/ -maxdepth 1 -type f -executable | while read collector; do
        "$collector"
    done | sort -u | while read domain; do
        echo ">> domain: $domain"
        sudo -u letsencrypt -g letsencrypt certbot certonly --quiet --non-interactive --agree-tos --keep-until-expiring --webroot -w /srv/letsencrypt/ -d "$domain"
    done

    find /etc/letsencrypt-allofthem/then/ -maxdepth 1 -type f -executable | while read hook; do
        "$hook"
    done
'''

[[file]]
path    = "/usr/lib/systemd/system/letsencrypt-allofthem.service"
content = """
    [Unit]
    Description=Provision and renew TLS certificates automatically
    After=network-online.target
    Wants=network-online.target

    [Service]
    Type=oneshot
    ExecStart=/usr/bin/letsencrypt-allofthem
    ExecStartPost=/usr/bin/systemctl reload nginx.service
"""

[[file]]
path    = "/usr/lib/systemd/system/letsencrypt-allofthem.timer"
content = """
    [Unit]
    Description=Provision and renew TLS certificates once a week
    After=network-online.target
    Wants=network-online.target

    [Timer]
    OnCalendar=weekly

    [Install]
    WantedBy=timers.target
"""

[[symlink]]
path   = "/etc/systemd/system/timers.target.wants/letsencrypt-allofthem.timer"
target = "/usr/lib/systemd/system/letsencrypt-allofthem.timer"
